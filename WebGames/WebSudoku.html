<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Game</title>
    <link rel="stylesheet" href="sudoku-style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../projects.html" class="back-btn" title="Back to Projects">‚Üê Back</a>
            <h1>üéÆ Sudoku</h1>
            <button id="nightModeToggle" class="night-mode-btn" title="Toggle Night Mode">üåô</button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">Time</div>
                <div class="stat-value" id="timer">00:00</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Moves</div>
                <div class="stat-value" id="moves">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Games Won</div>
                <div class="stat-value" id="gamesWon">0</div>
            </div>
        </div>

        <div class="difficulty-buttons">
            <button class="difficulty-btn active" data-difficulty="easy">Easy</button>
            <button class="difficulty-btn" data-difficulty="medium">Medium</button>
            <button class="difficulty-btn" data-difficulty="hard">Hard</button>
            <button class="difficulty-btn" data-difficulty="expert">Expert</button>
        </div>

        <div class="controls">
            <button id="hint">Hint</button>
            <button id="undo">Undo</button>
            <button id="check">Check</button>
            <button id="resetStats">Reset Stats</button>
        </div>

        <div class="message" id="message"></div>

        <div class="sudoku-board" id="board"></div>

        <div class="number-pad">
            <button class="number-btn" data-number="1">1</button>
            <button class="number-btn" data-number="2">2</button>
            <button class="number-btn" data-number="3">3</button>
            <button class="number-btn" data-number="4">4</button>
            <button class="number-btn" data-number="5">5</button>
            <button class="number-btn" data-number="6">6</button>
            <button class="number-btn" data-number="7">7</button>
            <button class="number-btn" data-number="8">8</button>
            <button class="number-btn" data-number="9">9</button>
            <button class="number-btn" data-number="0">Clear</button>
        </div>

        <div class="stats-panel">
            <h3>üìä Your Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Total Games</div>
                    <div class="stat-value" id="totalGames">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Best Time</div>
                    <div class="stat-value" id="bestTime">--:--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="winRate">0%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SudokuGame {
            constructor() {
                this.board = Array(9).fill(null).map(() => Array(9).fill(0));
                this.solution = Array(9).fill(null).map(() => Array(9).fill(0));
                this.startBoard = Array(9).fill(null).map(() => Array(9).fill(0));
                this.selectedCell = null;
                this.moves = 0;
                this.timer = 0;
                this.timerInterval = null;
                this.moveHistory = [];
                this.difficulty = 'easy';
                this.gameActive = false;
                
                this.difficultyLevels = {
                    easy: 35,
                    medium: 45,
                    hard: 52,
                    expert: 58
                };

                this.initializeElements();
                this.attachEventListeners();
                this.loadStats();
                this.updateStatsDisplay();
                this.loadNightMode();
                this.newGame();
            }

            initializeElements() {
                this.boardElement = document.getElementById('board');
                this.timerElement = document.getElementById('timer');
                this.movesElement = document.getElementById('moves');
                this.messageElement = document.getElementById('message');
                this.gamesWonElement = document.getElementById('gamesWon');
                this.totalGamesElement = document.getElementById('totalGames');
                this.bestTimeElement = document.getElementById('bestTime');
                this.winRateElement = document.getElementById('winRate');
            }

            attachEventListeners() {
                document.getElementById('hint').addEventListener('click', () => this.giveHint());
                document.getElementById('undo').addEventListener('click', () => this.undo());
                document.getElementById('check').addEventListener('click', () => this.checkBoard());
                document.getElementById('resetStats').addEventListener('click', () => this.resetStats());
                document.getElementById('nightModeToggle').addEventListener('click', () => this.toggleNightMode());

                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.difficulty = e.target.dataset.difficulty;
                        this.newGame();
                    });
                });

                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const number = parseInt(e.target.dataset.number);
                        this.inputNumber(number);
                    });
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key >= '1' && e.key <= '9') {
                        this.inputNumber(parseInt(e.key));
                    } else if (e.key === '0' || e.key === 'Backspace' || e.key === 'Delete') {
                        this.inputNumber(0);
                    }
                });
            }

            generateSolution() {
                // Fill diagonal 3x3 boxes first (they don't affect each other)
                for (let box = 0; box < 9; box += 3) {
                    this.fillBox(box, box);
                }
                // Fill remaining cells
                this.fillRemaining(0, 3);
                // Copy to solution
                this.solution = this.board.map(row => [...row]);
            }

            fillBox(row, col) {
                const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                this.shuffle(numbers);
                let num = 0;
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        this.board[row + i][col + j] = numbers[num++];
                    }
                }
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            fillRemaining(row, col) {
                if (col >= 9 && row < 8) {
                    row++;
                    col = 0;
                }
                if (row >= 9 && col >= 9) {
                    return true;
                }
                if (row < 3) {
                    if (col < 3) col = 3;
                } else if (row < 6) {
                    if (col === Math.floor(row / 3) * 3) col += 3;
                } else {
                    if (col === 6) {
                        row++;
                        col = 0;
                        if (row >= 9) return true;
                    }
                }

                for (let num = 1; num <= 9; num++) {
                    if (this.isSafe(row, col, num)) {
                        this.board[row][col] = num;
                        if (this.fillRemaining(row, col + 1)) {
                            return true;
                        }
                        this.board[row][col] = 0;
                    }
                }
                return false;
            }

            isSafe(row, col, num) {
                // Check row
                for (let x = 0; x < 9; x++) {
                    if (this.board[row][x] === num) return false;
                }
                // Check column
                for (let x = 0; x < 9; x++) {
                    if (this.board[x][col] === num) return false;
                }
                // Check 3x3 box
                const startRow = row - row % 3;
                const startCol = col - col % 3;
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        if (this.board[i + startRow][j + startCol] === num) return false;
                    }
                }
                return true;
            }

            removeNumbers(count) {
                let removed = 0;
                while (removed < count) {
                    const row = Math.floor(Math.random() * 9);
                    const col = Math.floor(Math.random() * 9);
                    if (this.board[row][col] !== 0) {
                        this.board[row][col] = 0;
                        removed++;
                    }
                }
            }

            newGame() {
                this.board = Array(9).fill(null).map(() => Array(9).fill(0));
                this.generateSolution();
                const cellsToRemove = this.difficultyLevels[this.difficulty];
                this.removeNumbers(cellsToRemove);
                this.startBoard = this.board.map(row => [...row]);
                
                this.moves = 0;
                this.timer = 0;
                this.moveHistory = [];
                this.gameActive = true;
                this.selectedCell = null;
                
                clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    if (this.gameActive) {
                        this.timer++;
                        this.updateTimer();
                    }
                }, 1000);

                this.updateMovesDisplay();
                this.renderBoard();
                this.hideMessage();
            }

            renderBoard() {
                this.boardElement.innerHTML = '';
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        
                        const value = this.board[row][col];
                        if (value !== 0) {
                            cell.textContent = value;
                            if (this.startBoard[row][col] !== 0) {
                                cell.classList.add('fixed');
                            } else {
                                cell.classList.add('correct');
                            }
                        }

                        cell.addEventListener('click', () => this.selectCell(row, col));
                        this.boardElement.appendChild(cell);
                    }
                }
            }

            selectCell(row, col) {
                if (!this.gameActive) return;
                if (this.startBoard[row][col] !== 0) return; // Can't select fixed cells

                this.selectedCell = { row, col };
                this.updateCellHighlights();
            }

            updateCellHighlights() {
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('selected', 'highlighted');
                });

                if (!this.selectedCell) return;

                const { row, col } = this.selectedCell;
                const cells = document.querySelectorAll('.cell');

                // Highlight selected cell
                const selectedIndex = row * 9 + col;
                cells[selectedIndex].classList.add('selected');

                // Highlight row, column, and box
                cells.forEach((cell, index) => {
                    const cellRow = Math.floor(index / 9);
                    const cellCol = index % 9;
                    
                    if (cellRow === row || cellCol === col) {
                        cell.classList.add('highlighted');
                    }

                    const boxRow = Math.floor(row / 3);
                    const boxCol = Math.floor(col / 3);
                    const cellBoxRow = Math.floor(cellRow / 3);
                    const cellBoxCol = Math.floor(cellCol / 3);
                    
                    if (boxRow === cellBoxRow && boxCol === cellBoxCol) {
                        cell.classList.add('highlighted');
                    }
                });
            }

            inputNumber(num) {
                if (!this.gameActive || !this.selectedCell) return;
                
                const { row, col } = this.selectedCell;
                if (this.startBoard[row][col] !== 0) return; // Can't modify fixed cells

                const oldValue = this.board[row][col];
                this.moveHistory.push({ row, col, value: oldValue });
                
                this.board[row][col] = num;
                this.moves++;
                this.updateMovesDisplay();
                this.renderBoard();
                this.updateCellHighlights();

                if (this.isComplete()) {
                    this.gameWon();
                }
            }

            isComplete() {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (this.board[row][col] === 0) return false;
                        if (this.board[row][col] !== this.solution[row][col]) return false;
                    }
                }
                return true;
            }

            checkBoard() {
                if (!this.gameActive) return;

                let hasErrors = false;
                const cells = document.querySelectorAll('.cell');
                
                cells.forEach((cell, index) => {
                    cell.classList.remove('error');
                    const row = Math.floor(index / 9);
                    const col = index % 9;
                    
                    if (this.board[row][col] !== 0 && 
                        this.board[row][col] !== this.solution[row][col]) {
                        cell.classList.add('error');
                        hasErrors = true;
                    }
                });

                if (hasErrors) {
                    this.showMessage('Some cells are incorrect!', 'info');
                } else if (this.isComplete()) {
                    this.gameWon();
                } else {
                    this.showMessage('Looking good so far!', 'info');
                }
            }

            giveHint() {
                if (!this.gameActive) return;

                const emptyCells = [];
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (this.board[row][col] === 0) {
                            emptyCells.push({ row, col });
                        }
                    }
                }

                if (emptyCells.length === 0) return;

                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                this.moveHistory.push({ 
                    row: randomCell.row, 
                    col: randomCell.col, 
                    value: this.board[randomCell.row][randomCell.col] 
                });
                
                this.board[randomCell.row][randomCell.col] = this.solution[randomCell.row][randomCell.col];
                this.moves++;
                this.updateMovesDisplay();
                this.renderBoard();
                this.showMessage('Hint placed!', 'info');

                if (this.isComplete()) {
                    this.gameWon();
                }
            }

            undo() {
                if (this.moveHistory.length === 0) return;
                
                const lastMove = this.moveHistory.pop();
                this.board[lastMove.row][lastMove.col] = lastMove.value;
                this.moves = Math.max(0, this.moves - 1);
                this.updateMovesDisplay();
                this.renderBoard();
                this.updateCellHighlights();
            }

            gameWon() {
                this.gameActive = false;
                clearInterval(this.timerInterval);
                
                // Update stats
                const stats = this.loadStats();
                stats.gamesPlayed++;
                stats.gamesWon++;
                
                if (!stats.bestTime || this.timer < stats.bestTime) {
                    stats.bestTime = this.timer;
                }
                
                this.saveStats(stats);
                
                // Force immediate update of all stat displays
                this.gamesWonElement.textContent = stats.gamesWon;
                this.totalGamesElement.textContent = stats.gamesPlayed;
                this.bestTimeElement.textContent = stats.bestTime ? this.formatTime(stats.bestTime) : '--:--';
                const winRate = stats.gamesPlayed > 0 
                    ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) 
                    : 0;
                this.winRateElement.textContent = winRate + '%';

                this.showMessage(`üéâ Congratulations! You won in ${this.formatTime(this.timer)} with ${this.moves} moves!`, 'success');
            }

            updateTimer() {
                this.timerElement.textContent = this.formatTime(this.timer);
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            updateMovesDisplay() {
                this.movesElement.textContent = this.moves;
            }

            showMessage(text, type) {
                this.messageElement.textContent = text;
                this.messageElement.className = 'message ' + type;
                this.messageElement.style.display = 'block';
                setTimeout(() => this.hideMessage(), 3000);
            }

            hideMessage() {
                this.messageElement.className = 'message';
                this.messageElement.style.display = 'none';
            }

            // Cookie/Stats Management
            loadStats() {
                const statsStr = this.getCookie('sudokuStats');
                if (statsStr) {
                    return JSON.parse(statsStr);
                }
                return {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    bestTime: null
                };
            }

            saveStats(stats) {
                this.setCookie('sudokuStats', JSON.stringify(stats), 365);
            }

            updateStatsDisplay() {
                const stats = this.loadStats();
                this.gamesWonElement.textContent = stats.gamesWon;
                this.totalGamesElement.textContent = stats.gamesPlayed;
                this.bestTimeElement.textContent = stats.bestTime ? this.formatTime(stats.bestTime) : '--:--';
                
                const winRate = stats.gamesPlayed > 0 
                    ? Math.round((stats.gamesWon / stats.gamesPlayed) * 100) 
                    : 0;
                this.winRateElement.textContent = winRate + '%';
            }

            resetStats() {
                if (confirm('Are you sure you want to reset all statistics?')) {
                    this.saveStats({
                        gamesPlayed: 0,
                        gamesWon: 0,
                        bestTime: null
                    });
                    this.updateStatsDisplay();
                    this.showMessage('Statistics reset!', 'info');
                }
            }

            setCookie(name, value, days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + date.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/";
            }

            getCookie(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }

            toggleNightMode() {
                document.body.classList.toggle('night-mode');
                const isNightMode = document.body.classList.contains('night-mode');
                const toggleBtn = document.getElementById('nightModeToggle');
                toggleBtn.textContent = isNightMode ? '‚òÄÔ∏è' : 'üåô';
                this.setCookie('nightMode', isNightMode ? 'true' : 'false', 365);
            }

            loadNightMode() {
                const nightMode = this.getCookie('nightMode');
                if (nightMode === 'true') {
                    document.body.classList.add('night-mode');
                    document.getElementById('nightModeToggle').textContent = '‚òÄÔ∏è';
                }
            }
        }

        // Initialize the game when page loads
        const game = new SudokuGame();
    </script>
</body>
</html>
